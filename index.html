<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecosmetic Bin</title>
    <style>
        body {
            text-align: center;
            align-items: center;
        }
        table { 
            border: 1px solid;
            border-collapse: collapse;
            border-top: none;
            margin: auto;
            display: none;
            margin: 20px;
        }
        caption {
            caption-side: bottom;
        }
        td {
            width : 100px;
            height : 100px;
            padding-left: 20px;
            padding-right: 20px;
        }
        tr, td {
            border: none;
        }
        .hidden {
            display: none;
        }
    </style>
    <script src="./mqttio.js" type="text/javascript"></script>
    <script>
        screen.orientation.lock("portrait-primary");


        let total = 0;
        let intervalId = null;
        let hiddenItems = document.getElementsByClassName("hidden");
        let tables = document.getElementsByClassName("trashbin");
        let count = 0;
        let tdLoc = 0;

        function init() {
            total = 0;
        }

        function userLogin() {
            let userName = document.getElementById("getUserName").value.trim();
            document.getElementById("userName").innerHTML += userName;
            document.getElementById("getUserName").style.display = "none";
            document.getElementById("loginButton").style.display = "none";
            document.getElementById("operateButton").innerHTML = "start";
            for (let i = 0; i < hiddenItems.length; i++) {
                hiddenItems[i].style.display = "inline";
            }
            
            for (let i = 0; i < tables.length; i++) {
                tables[i].style.display = "inline-table";
            }
            document.getElementById("total").innerHTML = "배출량: " + total;
        }

        function userLogout() {
            init();
            document.getElementById("loginButton").style.display = "inline";
            document.getElementById("userName").innerHTML = "사용자 이름: ";
            document.getElementById("getUserName").style.display = "inline";
            document.getElementById("getUserName").value = "";
            let hiddenItems = document.getElementsByClassName("hidden");
            for (let i = 0; i < hiddenItems.length; i++) {
                hiddenItems[i].style.display = "none";
            }
            let tables = document.getElementsByClassName("trashbin");
            for (let i = 0; i < tables.length; i++) {
                tables[i].style.display = "none";
            }
        }

        function operate() {
            let operateButton =  document.getElementById("operateButton").innerHTML;
            if(operateButton == "start") {
                count++;
                if(count % 2 == 0) {
                    intervalId = setInterval(function() { moveImageDown('glass', './2.png'); }, 300);
                }
                else {
                    intervalId = setInterval(function() { moveImageDown('plastic', './1.png'); }, 300);
                }
                document.getElementById("operateButton").innerHTML = "finish";
                total++;
                document.getElementById("total").innerHTML = "배출량: " + total;
                
            } 
            else {
                clearInterval(intervalId);
                document.getElementById("operateButton").innerHTML = "start";
            } 
        }

        function moveImageDown(tableId, imgPath) {
            let table = document.getElementById(tableId + "Table");
            let tds = table.getElementsByTagName("td");
            let imgHtml = `<img src="${imgPath}" width="100" height="90">`;
            if(tdLoc != 0) {
                tds[tdLoc - 1].innerHTML = '';
            }
            tds[tdLoc].innerHTML = imgHtml;
            tdLoc++;
            if(tdLoc == tds.length || tds[tdLoc].querySelector("img")) {
                tdLoc = 0;
                clearInterval(intervalId);
            }
        }

        function cleanTrashcan() {
            let tds = document.getElementsByTagName("td");
            for(let i=0; i<tds.length; i++) {
                tds[i].innerHTML = '';
            }
            total = 0;
            document.getElementById("total").innerHTML = "배출량: " + total;
        }

    </script>
</head>
<body>
    <h1>Ecosmetic Bin</h1>
    <hr>
    <div id="messages"></div>
    <label for="getUserName" id="userName" >사용자 이름: </label>
    <input type="text" id="getUserName">
    <button onclick="userLogin()" id="loginButton">Login</button> 
    <button onclick="userLogout()" id="logoutButton" class="hidden">Logout</button>
    <br>
    <span id="total" class="hidden">배출량: </span><br>
    <button onclick="operate()" id="operateButton" class="hidden">start</button>
    <button onclick="cleanTrashcan()" id="operateButton" class="hidden">clean</button><br><br>
    <table class="trashbin" id="glassTable">
        <caption>유리</caption>
        <tr><td></td></tr>
        <tr><td></td></tr>
        <tr><td></td></tr>
        <tr><td></td></tr>
        <tr><td></td></tr>
    </table> 
    <table class="trashbin" id="plasticTable">
        <caption>플라스틱</caption>
        <tr><td></td></tr>
        <tr><td></td></tr>
        <tr><td></td></tr>
        <tr><td></td></tr>
        <tr><td></td></tr>
    </table> 
    <table class="trashbin" id="aluminiumTable">
        <caption>금속</caption>
        <tr><td></td></tr>
        <tr><td></td></tr>
        <tr><td></td></tr>
        <tr><td></td></tr>
        <tr><td></td></tr>
    </table>
</body>
</html>